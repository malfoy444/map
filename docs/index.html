<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commute Planner Mockup</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root { --accent:#2563eb; --muted:#6b7280; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; color:#111827; }
  header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px; }
  h1 { font-size:1.15rem; margin:0; }
  .muted { color: var(--muted); }
  .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; padding:10px; border:1px solid #e5e7eb; border-radius:10px; }
  .controls label { font-size:.85rem; color:#374151; }
  .controls input, .controls select, .controls button { padding:.4rem .6rem; font-size:1rem; border:1px solid #e5e7eb; border-radius:8px; background:#fff; }
  .controls button { border-color:#d1d5db; cursor:pointer; }
  .controls button.primary { background: var(--accent); color:white; border-color: var(--accent); }
  .grid { display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; }
  @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }
  .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
  .list { display:flex; flex-direction:column; gap:10px; }
  .trip { border:1px solid #e5e7eb; border-radius:10px; padding:10px; }
  .trip.best { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(37,99,235,.12); }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .badge { border:1px solid #d1d5db; border-radius:999px; padding:.15rem .5rem; font-size:.75rem; color:#374151; }
  .mode { text-transform:uppercase; font-weight:600; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  a.link { color: var(--accent); text-decoration: none; border-bottom:1px dashed var(--accent); }
  .tiny { font-size:.8rem; }
  .warning { color:#b45309; }
  .pill { background:#f3f4f6; border-radius:999px; padding:.15rem .5rem; font-size:.8rem; }
</style>
</head>
<body>
<header>
  <h1>üöÜ Commute Planner (Mockup)</h1>
  <div class="muted tiny">Single-file demo ‚Ä¢ Offline-capable when hosted over HTTPS</div>
</header>

<div class="controls">
  <div class="row">
    <label>Preset</label>
    <select id="preset">
      <option value="outbound">Home ‚Üí bol</option>
      <option value="return">bol ‚Üí Home</option>
    </select>
  </div>
  <div class="row">
    <label>Date</label>
    <input id="date" type="date">
    <label>Time</label>
    <input id="time" type="time" step="60">
  </div>
  <div class="row">
    <label>Buffer</label>
    <input id="buffer" type="number" min="0" max="15" value="4" style="width:4rem"> min
  </div>
  <div class="row">
    <label>Window</label>
    <select id="window">
      <option value="60">next 1h</option>
      <option value="120" selected>next 2h</option>
      <option value="180">next 3h</option>
    </select>
  </div>
  <div class="row">
    <label>Bike duration</label>
    <input id="bike" type="number" min="5" max="25" value="10" style="width:4rem"> min
  </div>
  <div class="row">
    <label>Scenario</label>
    <select id="scenario">
      <option value="normal" selected>Normal</option>
      <option value="woerden_issue">Woerden/Gouda issue</option>
      <option value="rotterdam_issue">Rotterdam issue</option>
      <option value="rotterdam_hard">Rotterdam hard (use Metro‚ÜíDH)</option>
    </select>
  </div>
  <button id="search" class="primary">Search</button>
</div>

<div class="grid">
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div><strong>Results</strong></div>
      <div class="tiny muted">Sorted by leave time ‚Üí total duration</div>
    </div>
    <div id="results" class="list"></div>
  </div>
  <div class="card">
    <strong>Notes</strong>
    <ul class="tiny">
      <li>Calendar chooser supports <em>weekday/weekend</em> plus carrier ranges like <strong>RET_SUMMER</strong> (e.g., yearly July‚ÄìAug).</li>
      <li>Carrier links are generated from templates using actual from/to/time (NS/RET examples wired).</li>
      <li>The bike segment is flexible; change its minutes to update the ‚Äúleave home‚Äù time.</li>
      <li>This is a mock dataset. Replace times with real ones later.</li>
    </ul>
    <div class="tiny muted">Build: mock v0.2</div>
  </div>
</div>

<script>
/* ----------------------- MOCK DATASET ----------------------- */
const DATA = {
  timezone: "Europe/Amsterdam",
  default_transfer_minutes: 4,

  presets: [
    { id: "outbound", label: "Home ‚Üí bol", origin:"home", destination:"bol" },
    { id: "return", label: "bol ‚Üí Home", origin:"bol", destination:"home" }
  ],

  calendars: {
    WEEKDAY: { days: [1,2,3,4,5] },
    WEEKEND: { days: [0,6] },

    // Applies every year (inclusive)
    RET_SUMMER: {
      yearly_ranges: [{ from: "--07-01", to: "--08-31" }]
    },
    // Example year-specific override (preferred over yearly_ranges if present)
    RET_SUMMER_OVERRIDES: {
      ranges: [{ from: "2025-07-08", to: "2025-08-25" }]
    }
  },

  scenarios: [
    { id: "normal", label:"Normal", default:true },
    { id: "woerden_issue", label:"Issue near Woerden/Gouda" },
    { id: "rotterdam_issue", label:"Issue at/around Rotterdam" },
    { id: "rotterdam_hard", label:"Rotterdam + Schiedam out (use Metro‚ÜíDen Haag)" }
  ],

  templates: {
    ns_direct: "https://www.ns.nl/reisplanner/#/?vertrek={fromLabel}&vertrektype=treinstation&aankomst={toLabel}&aankomsttype=treinstation&type=vertrek&tijd={iso}&firstMileModality=PUBLIC_TRANSPORT&lastMileModality=PUBLIC_TRANSPORT",
    ret_metro: "https://www.ret.nl/home/reizen/reisplanner/details/{fromSlug}/n-a/{toSlug}/{date_dmy}/{time_hhmm}/vertrek/snelste-route/1-2-0-3/geen-extra-overstaptijd/0/0/niet-extra-toegankelijk.html"
  },

  labelMaps: {
    ns: {
      schiedam_c: "Schiedam%20Centrum",
      rotterdam_c: "Rotterdam%20Centraal",
      utrecht_c: "Utrecht%20Centraal",
      denhaag_c: "Den%20Haag%20Centraal",
      amsterdam_zuid: "Amsterdam%20Zuid"
    },
    ret: {
      pernis_metro: "metrostation-pernis_pernis-rotterdam",
      schiedam_c: "metrostation-schiedam-centrum_schiedam",
      beurs: "beurs_rotterdam",
    }
  },

  stops: {
    home:{name:"Home"}, bol:{name:"bol"},
    pernis_metro:{name:"Pernis (Metro)"}, schiedam_c:{name:"Schiedam Centrum"},
    rotterdam_c:{name:"Rotterdam Centraal"}, utrecht_c:{name:"Utrecht Centraal"},
    denhaag_c:{name:"Den Haag Centraal"}, amsterdam_zuid:{name:"Amsterdam Zuid"},
    beurs:{name:"Beurs (Metro)"}, papendorp_zuid:{name:"Papendorp Zuid"}
  },

  legs: [
    // Flex legs
    { id:"bike_home_pernis", from:"home", to:"pernis_metro", mode:"bike", behavior:"flex", duration_minutes:10 },

    // Metro RET (uses RET_SUMMER when applicable)
    { id:"metro_pernis_schiedam", from:"pernis_metro", to:"schiedam_c", mode:"metro", carrier:"ret", linkTemplate:"ret_metro",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"06:10",arr:"06:22"}, {dep:"06:20",arr:"06:32"}, {dep:"06:30",arr:"06:42"}, {dep:"06:40",arr:"06:52"} ],
        WEEKEND: [ {dep:"07:00",arr:"07:12"}, {dep:"07:15",arr:"07:27"}, {dep:"07:30",arr:"07:42"} ],
        RET_SUMMER: [ {dep:"06:15",arr:"06:27"}, {dep:"06:30",arr:"06:42"}, {dep:"06:45",arr:"06:57"} ]
      }
    },

    // Train Schiedam -> Rotterdam (NS)
    { id:"train_schiedam_rotterdam", from:"schiedam_c", to:"rotterdam_c", mode:"train", carrier:"ns", linkTemplate:"ns_direct",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"06:22",arr:"06:28"}, {dep:"06:37",arr:"06:43"}, {dep:"06:52",arr:"06:58"} ],
        WEEKEND: [ {dep:"07:07",arr:"07:13"}, {dep:"07:22",arr:"07:28"} ]
      },
      blocked_by:["rotterdam_hard"] // if everything around Rotterdam is down
    },

    // Direct train Rotterdam -> Utrecht (NS) ‚Äî blocked on issues
    { id:"train_rotterdam_utrecht_direct", from:"rotterdam_c", to:"utrecht_c", mode:"train", carrier:"ns", linkTemplate:"ns_direct",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"06:28",arr:"07:03"}, {dep:"06:58",arr:"07:34"}, {dep:"07:28",arr:"08:03"} ],
        WEEKEND: [ {dep:"07:28",arr:"08:05"}, {dep:"07:58",arr:"08:36"} ]
      },
      blocked_by:["woerden_issue","rotterdam_issue","rotterdam_hard"]
    },

    // Detour via Amsterdam Zuid
    { id:"train_rotterdam_amsterdamzuid", from:"rotterdam_c", to:"amsterdam_zuid", mode:"train", carrier:"ns", linkTemplate:"ns_direct",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"06:19",arr:"07:09"}, {dep:"06:49",arr:"07:39"} ],
        WEEKEND: [ {dep:"07:19",arr:"08:09"} ]
      },
      blocked_by:["rotterdam_issue","rotterdam_hard"]
    },
    { id:"train_amsterdamzuid_utrecht", from:"amsterdam_zuid", to:"utrecht_c", mode:"train", carrier:"ns", linkTemplate:"ns_direct",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"07:12",arr:"07:42"}, {dep:"07:42",arr:"08:12"}, {dep:"08:12",arr:"08:42"} ],
        WEEKEND: [ {dep:"08:12",arr:"08:42"} ]
      }
    },

    // Detour via Den Haag C
    { id:"train_rotterdam_denhaag", from:"rotterdam_c", to:"denhaag_c", mode:"train", carrier:"ns", linkTemplate:"ns_direct",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"06:10",arr:"06:35"}, {dep:"06:25",arr:"06:50"}, {dep:"06:55",arr:"07:20"} ],
        WEEKEND: [ {dep:"07:10",arr:"07:35"} ]
      },
      blocked_by:["rotterdam_hard"]
    },
    { id:"train_denhaag_utrecht", from:"denhaag_c", to:"utrecht_c", mode:"train", carrier:"ns", linkTemplate:"ns_direct",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"06:40",arr:"07:18"}, {dep:"07:00",arr:"07:38"}, {dep:"07:20",arr:"07:58"} ],
        WEEKEND: [ {dep:"07:20",arr:"07:58"} ]
      }
    },

    // Rotterdam hard: use RET metro to DH
    { id:"metro_pernis_beurs", from:"pernis_metro", to:"beurs", mode:"metro", carrier:"ret", linkTemplate:"ret_metro",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"06:05",arr:"06:30"}, {dep:"06:20",arr:"06:45"}, {dep:"06:35",arr:"07:00"} ],
        WEEKEND: [ {dep:"07:05",arr:"07:30"}, {dep:"07:20",arr:"07:45"} ],
        RET_SUMMER: [ {dep:"06:10",arr:"06:35"}, {dep:"06:25",arr:"06:50"} ]
      }
    },
    { id:"metro_beurs_denhaag", from:"beurs", to:"denhaag_c", mode:"metro", carrier:"ret", linkTemplate:"ret_metro",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"06:35",arr:"07:20"}, {dep:"06:50",arr:"07:35"} ],
        WEEKEND: [ {dep:"07:35",arr:"08:20"} ],
        RET_SUMMER: [ {dep:"06:40",arr:"07:25"} ]
      }
    },

    // Last mile
    { id:"bus_shuttle_utrecht_bol", from:"utrecht_c", to:"bol", mode:"bus", carrier:"shuttle", linkTemplate:"ns_direct",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"07:15",arr:"07:27"}, {dep:"07:30",arr:"07:42"}, {dep:"07:45",arr:"07:57"} ],
        WEEKEND: []
      }
    },
    { id:"bus_qbuzz_utrecht_papendorp", from:"utrecht_c", to:"papendorp_zuid", mode:"bus", carrier:"qbuzz", linkTemplate:"ns_direct",
      tripsByCalendar: {
        WEEKDAY: [ {dep:"07:12",arr:"07:22"}, {dep:"07:24",arr:"07:34"}, {dep:"07:36",arr:"07:46"} ],
        WEEKEND: [ {dep:"08:00",arr:"08:12"} ]
      }
    },
    { id:"walk_papendorp_bol", from:"papendorp_zuid", to:"bol", mode:"walk", behavior:"flex", duration_minutes:8 }
  ]
};

/* ----------------------- HELPERS ----------------------- */
function pad(n){ return String(n).padStart(2,'0'); }
function toDate(dStr,tStr){ return new Date(`${dStr}T${tStr}:00`); }
function ymd(d){ return d.toISOString().slice(0,10); }
function dmy(d){ return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`; }
function hhmm(d){ return `${pad(d.getHours())}${pad(d.getMinutes())}`; }
function fmtHM(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function addMin(d, m){ return new Date(d.getTime()+m*60000); }
function sameDay(d1,d2){ return d1.toDateString() === d2.toDateString(); }

function inRange(date, fromStr, toStr){
  const y = date.getFullYear();
  const toDate2 = (s)=>{
    if (s.startsWith('--')) {
      const [,m,d]=s.match(/^--(\d{2})-(\d{2})$/);
      return new Date(y, Number(m)-1, Number(d));
    } else {
      const [Y,M,D]=s.split('-').map(Number);
      return new Date(Y, M-1, D);
    }
  };
  let a = toDate2(fromStr), b = toDate2(toStr);
  if (a > b && fromStr.startsWith('--') && toStr.startsWith('--')) {
    const endYear = new Date(y,11,31), startYear = new Date(y,0,1);
    return (date>=a && date<=endYear) || (date>=startYear && date<=b);
  }
  return date>=a && date<=b;
}

// pick first matching calendar from a list of candidates
function pickCalendarKey(date, calendars, candidateKeys){
  // explicit ranges
  for (const key of candidateKeys){
    const cal = calendars[key]; if (!cal) continue;
    const ranges = cal.ranges || [];
    for (const r of ranges){ if (inRange(date, r.from, r.to)) return key; }
  }
  // yearly ranges
  for (const key of candidateKeys){
    const cal = calendars[key]; if (!cal) continue;
    const yr = cal.yearly_ranges || [];
    for (const r of yr){ if (inRange(date, r.from, r.to)) return key; }
  }
  // day-of-week
  const dow = date.getDay();
  for (const key of candidateKeys){
    const cal = calendars[key]; if (!cal) continue;
    if (Array.isArray(cal.days) && cal.days.includes(dow)) return key;
  }
  return candidateKeys[0] || 'WEEKDAY';
}

function renderCarrierUrl(templateKey, carrierKey, fromId, toId, depDateTime){
  const t = DATA.templates[templateKey];
  if (!t) return '#';
  const maps = DATA.labelMaps[carrierKey] || {};
  const fromLabel = maps[fromId] ?? encodeURIComponent(fromId);
  const toLabel = maps[toId] ?? encodeURIComponent(toId);
  return t
    .replaceAll('{fromLabel}', fromLabel)
    .replaceAll('{toLabel}', toLabel)
    .replaceAll('{fromSlug}', fromLabel)
    .replaceAll('{toSlug}', toLabel)
    .replaceAll('{iso}', `${ymd(depDateTime)}T${pad(depDateTime.getHours())}:${pad(depDateTime.getMinutes())}`)
    .replaceAll('{date_dmy}', dmy(depDateTime))
    .replaceAll('{time_hhmm}', hhmm(depDateTime));
}

/* ----------------------- PLANNER ----------------------- */
function activeLegs(scenarioId){
  return DATA.legs.filter(l => !(l.blocked_by || []).includes(scenarioId));
}

function candidateCalendarKeysForLeg(leg){
  const base = ['WEEKDAY','WEEKEND'];
  if (leg.carrier === 'ret') return ['RET_SUMMER_OVERRIDES','RET_SUMMER', ...base];
  return ['HOLIDAY', ...base];
}

function getTripsForLegOnDate(leg, date){
  if (!leg.tripsByCalendar) return [];
  const keys = candidateCalendarKeysForLeg(leg);
  const calKey = pickCalendarKey(date, DATA.calendars, keys);
  return leg.tripsByCalendar[calKey] || [];
}

// Simple time-aware search (beam)
function findRoutes(origin, destination, departDate, bufferMin, windowMin, scenarioId, bikeMinutes){
  const legs = activeLegs(scenarioId);
  legs.forEach(l => { if (l.id==='bike_home_pernis') l.duration_minutes = bikeMinutes; });

  const byFrom = {};
  for (const leg of legs){
    if (!byFrom[leg.from]) byFrom[leg.from] = [];
    byFrom[leg.from].push(leg);
  }

  const results = [];
  const deadline = addMin(departDate, windowMin);
  const queue = [{ at: origin, time: new Date(departDate), path: [], lastArr: new Date(departDate) }];

  while (queue.length){
    const state = queue.shift();
    if (state.time > deadline) continue;
    const nextLegs = byFrom[state.at] || [];

    for (const leg of nextLegs){
      if (leg.behavior === 'flex'){
        const dep = state.time;
        const arr = addMin(dep, leg.duration_minutes || 0);
        const next = { at: leg.to, time: arr, path: [...state.path, {leg, dep, arr}], lastArr: arr };
        if (leg.to === destination) results.push(next); else queue.push(next);
      } else {
        const trips = getTripsForLegOnDate(leg, state.time);
        const minDepTime = addMin(state.lastArr, bufferMin);
        for (const t of trips){
          const dep = new Date(`${ymd(state.time)}T${t.dep}:00`);
          const arr = new Date(`${ymd(state.time)}T${t.arr}:00`);
          if (dep < minDepTime) continue;
          const next = { at: leg.to, time: arr, path: [...state.path, {leg, dep, arr}], lastArr: arr };
          if (leg.to === destination) results.push(next); else queue.push(next);
          break; // first feasible only per branch (keeps it small)
        }
      }
    }

    if (queue.length > 100) break;
    queue.sort((a,b) => a.time - b.time);
  }

  const seen = new Set();
  const shaped = results.map(r => {
    const leave = (r.path[0]?.dep) || departDate;
    const arrive = r.lastArr;
    const total = Math.round((arrive - departDate)/60000);
    return { leave, arrive, total, legs: r.path };
  }).filter(x => x.arrive <= deadline);

  const uniq = [];
  for (const r of shaped){
    const key = r.legs.map(x => x.leg.id).join('>') + '|' + r.arrive.toISOString();
    if (!seen.has(key)){ seen.add(key); uniq.push(r); }
  }
  uniq.sort((a,b) => (a.leave - b.leave) || (a.total - b.total));
  return uniq.slice(0, 12);
}

/* ----------------------- UI ----------------------- */
function init(){
  const now = new Date();
  document.getElementById('date').value = ymd(now);
  document.getElementById('time').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  document.getElementById('preset').value = 'outbound';
  document.getElementById('scenario').value = 'normal';
  document.getElementById('search').addEventListener('click', run);
  run();
}

function renderTrip(trip, idx, bufferMin){
  const div = document.createElement('div');
  div.className = 'trip' + (idx===0 ? ' best' : '');

  const head = document.createElement('div');
  head.className = 'row';
  head.innerHTML = `<strong>Leave</strong> <span class="mono">${fmtHM(trip.leave)}</span>
                    <span class="muted">‚Üí</span>
                    <strong>Arrive</strong> <span class="mono">${fmtHM(trip.arrive)}</span>
                    <span class="pill">Total ${trip.total} min</span>`;
  div.appendChild(head);

  const list = document.createElement('ol');
  list.style.margin = '.5rem 0 0 1rem';
  list.style.padding = 0;

  for (let i=0;i<trip.legs.length;i++){
    const s = trip.legs[i];
    const prev = i>0 ? trip.legs[i-1] : null;
    const gap = prev ? Math.max(0, Math.round((s.dep - prev.arr)/60000)) : null;
    const link = (s.leg.linkTemplate && s.leg.carrier) ? renderCarrierUrl(
      s.leg.linkTemplate, s.leg.carrier, s.leg.from, s.leg.to, s.dep
    ) : null;

    const li = document.createElement('li');
    li.style.margin = '.35rem 0';
    li.innerHTML = `<span class="badge mode">${s.leg.mode}</span> ${DATA.stops[s.leg.from]?.name || s.leg.from} ‚Üí ${DATA.stops[s.leg.to]?.name || s.leg.to}
      | dep <span class="mono">${fmtHM(s.dep)}</span> ‚Üí arr <span class="mono">${fmtHM(s.arr)}</span>
      ${gap!==null ? ` ‚Ä¢ transfer <span class="${gap < bufferMin ? 'warning' : ''}">${gap} min</span>` : ''}
      ${link ? ` ‚Ä¢ <a target="_blank" rel="noopener" class="link" href="${link}">carrier</a>` : ''}`;
    list.appendChild(li);
  }
  div.appendChild(list);
  return div;
}

function run(){
  const dateStr = document.getElementById('date').value;
  const timeStr = document.getElementById('time').value;
  const buffer = parseInt(document.getElementById('buffer').value,10) || DATA.default_transfer_minutes;
  const windowMin = parseInt(document.getElementById('window').value,10);
  const scenario = document.getElementById('scenario').value;
  const bike = parseInt(document.getElementById('bike').value,10) || 10;
  const preset = document.getElementById('preset').value;

  const depart = toDate(dateStr, timeStr);
  const p = DATA.presets.find(p=>p.id===preset) || DATA.presets[0];
  const routes = findRoutes(p.origin, p.destination, depart, buffer, windowMin, scenario, bike);

  const host = document.getElementById('results');
  host.innerHTML = '';
  if (!routes.length){
    host.innerHTML = `<div class="muted">No feasible trips in the selected window.</div>`;
    return;
  }
  routes.forEach((trip, idx) => host.appendChild(renderTrip(trip, idx, buffer)));
}

init();

// Service worker registration stub (for when you host over HTTPS)
if ('serviceWorker' in navigator) {
  const canSW = (location.protocol === 'https:' || location.hostname === 'localhost');
  if (canSW) {
    // navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  }
}
</script>
</body>
</html>
